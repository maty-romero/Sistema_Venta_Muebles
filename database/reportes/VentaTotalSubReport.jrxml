<?xml version="1.0" encoding="UTF-8"?>
<!-- Created with Jaspersoft Studio version 6.21.2.final using JasperReports Library version 6.21.2-8434a0bd7c3bbc37cbf916f2968d35e4b165821a  -->
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="TotalVentaSubReport" pageWidth="595" pageHeight="842" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="c09e5bbb-472f-4620-b02b-d48ca95cfecf">
	<property name="com.jaspersoft.studio.data.sql.tables" value=""/>
	<property name="com.jaspersoft.studio.data.defaultdataadapter" value="MysqlAdapter"/>
	<parameter name="NroVenta" class="java.lang.String"/>
	<queryString language="SQL">
		<![CDATA[SELECT 
                v.monto_final_venta AS monto_final_venta, 
                v.nro_pago, 
                o.porcentaje_descuento AS porcentaje_descuento,
                subquery.total_sin_descuento as total_sin_descuento,
                (subquery.total_sin_descuento - v.monto_final_venta) AS monto_descuento
            FROM ventas v 
            LEFT JOIN ofertas_montos ofm ON v.id_oferta_monto = ofm.id_oferta_monto
            LEFT JOIN ofertas o ON ofm.id_oferta_monto = o.id,
            (
                SELECT 
                    COALESCE(SUM(total), 0) AS total_sin_descuento
                FROM (
                    SELECT 
                        SUM(producto_venta.unidades_vendidas_prod * producto_venta.precio_venta_prod) AS total
                    FROM 
                        producto_venta 
                    LEFT JOIN 
                        productos ON productos.id = producto_venta.id_producto
                    WHERE 
                        producto_venta.id_venta = $P{NroVenta}
                    
                    UNION ALL
                    
                    SELECT 
                        SUM(oferta_combo_venta.unidades_vendidas_combo * oferta_combo_venta.precio_combo) AS total
                    FROM 
                        oferta_combo_venta 
                    LEFT JOIN 
                        oferta_combo ON oferta_combo.id_oferta_combo = oferta_combo_venta.id_oferta_combo
                    WHERE 
                        oferta_combo_venta.id_venta = $P{NroVenta}
                ) AS subquery
            ) AS subquery
            WHERE v.id = $P{NroVenta};
		]]>
	</queryString>
	<field name="monto_final_venta" class="java.math.BigDecimal">
		<property name="com.jaspersoft.studio.field.name" value="monto_final_venta"/>
		<property name="com.jaspersoft.studio.field.label" value="monto_final_venta"/>
	</field>
	<field name="nro_pago" class="java.lang.Integer">
		<property name="com.jaspersoft.studio.field.name" value="nro_pago"/>
		<property name="com.jaspersoft.studio.field.label" value="nro_pago"/>
	</field>
	<field name="porcentaje_descuento" class="java.math.BigDecimal">
		<property name="com.jaspersoft.studio.field.name" value="porcentaje_descuento"/>
		<property name="com.jaspersoft.studio.field.label" value="porcentaje_descuento"/>
	</field>
	<field name="total_sin_descuento" class="java.math.BigDecimal">
		<property name="com.jaspersoft.studio.field.name" value="total_sin_descuento"/>
		<property name="com.jaspersoft.studio.field.label" value="total_sin_descuento"/>
	</field>
	<field name="monto_descuento" class="java.math.BigDecimal">
		<property name="com.jaspersoft.studio.field.name" value="monto_descuento"/>
		<property name="com.jaspersoft.studio.field.label" value="monto_descuento"/>
	</field>
	<background>
		<band height="8" splitType="Stretch"/>
	</background>
	<pageFooter>
		<band height="101" splitType="Stretch">
			<rectangle>
				<reportElement x="230" y="-4" width="331" height="95" uuid="30900599-4059-49a5-a7a1-e54ecc40637a"/>
			</rectangle>
			<textField>
				<reportElement x="390" y="-4" width="170" height="20" uuid="a233f750-3dca-412b-96d6-022b6ca2791b"/>
				<textFieldExpression><![CDATA["#"+$F{nro_pago}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="230" y="16" width="150" height="20" forecolor="#030303" uuid="b9594ce8-ed3b-4e9b-80fe-fc30e60f0d28"/>
				<textElement textAlignment="Center">
					<font size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Subtotal:]]></text>
			</staticText>
			<textField>
				<reportElement x="390" y="16" width="170" height="20" uuid="cd5bc1dd-b288-478b-936e-c326297d66d4"/>
				<textFieldExpression><![CDATA["$"+$F{total_sin_descuento}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="230" y="36" width="150" height="20" forecolor="#030303" uuid="b9594ce8-ed3b-4e9b-80fe-fc30e60f0d28"/>
				<textElement textAlignment="Center">
					<font size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Descuento por monto:]]></text>
			</staticText>
			<textField>
				<reportElement mode="Transparent" x="390" y="36" width="170" height="20" forecolor="#030303" backcolor="#FFFFFF" uuid="f7d52609-b20b-4773-b261-3564e5cd69f4"/>
				<textFieldExpression><![CDATA[($F{monto_descuento} != null ? "- $" + $F{monto_descuento} + " (" + ($F{porcentaje_descuento} != null ? $F{porcentaje_descuento} + "%" : "No aplica") + ")" : "No aplica")]]></textFieldExpression>
			</textField>
			<rectangle>
				<reportElement x="230" y="60" width="330" height="31" forecolor="#000000" backcolor="#030303" uuid="2908b671-902d-4a65-8965-9138fbeb064c"/>
			</rectangle>
			<staticText>
				<reportElement x="230" y="-4" width="150" height="20" forecolor="#030303" uuid="d9dd7346-c34f-44b4-91b2-27c2a6ec42eb"/>
				<textElement textAlignment="Center">
					<font size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Nro. de pago:]]></text>
			</staticText>
			<staticText>
				<reportElement x="270" y="65" width="70" height="20" forecolor="#FFFFFF" uuid="cffae6b5-4818-45e1-bcce-e44d7c33800f"/>
				<textElement textAlignment="Center">
					<font size="14" isBold="true"/>
				</textElement>
				<text><![CDATA[Total:]]></text>
			</staticText>
			<textField>
				<reportElement x="390" y="64" width="175" height="23" forecolor="#FFFFFF" uuid="f7d52609-b20b-4773-b261-3564e5cd69f4"/>
				<textElement textAlignment="Left">
					<font size="14" isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA["$"+$F{monto_final_venta}]]></textFieldExpression>
			</textField>
		</band>
	</pageFooter>
</jasperReport>
